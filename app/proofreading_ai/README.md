## 校正AIロジック設計詳細（参考: FastAPI版 app.py/view_dev.html）

### 基本思想
- 校正AIの校正結果（ハイライトやツールチップ含むHTML）は**サーバー側で生成**し、フロントエンドは**innerHTMLでそのまま表示**する。
- JS側でエスケープやハイライト処理は行わず、サーバーから返されたHTMLをそのまま描画する。
- 校正辞書やパラメータもサーバー側で管理。

### 処理フロー
1. クライアント（JS）は入力テキスト・パラメータをAPI（WebSocket/HTTP）に送信
2. サーバー側でAI（Claude等）＋校正辞書で校正を実行
3. 校正結果（correctionsリスト）をもとに、
    - 元テキストの該当箇所を`<span class="correction-span">...</span>`等でラップし、
    - ツールチップや修正案ボタンもHTMLで組み立てる
4. サーバーは**ハイライト付きHTML文字列**を返す
5. フロントは`correctionResult.innerHTML = ...`でそのまま表示
6. ハイライト部分のクリックイベントや修正案選択のみJSで制御

### 主要関数の役割
- `format_corrections(original_text, corrections)`
    - 元テキストとcorrectionsリストから、ハイライト付きHTMLを生成
    - 例: 元文の該当箇所を`<span class="correction-span">...</span>`でラップし、ツールチップや修正案ボタンもHTMLで埋め込む
- 校正辞書の管理・適用もサーバー側で行う

### メリット
- タグやエスケープの混乱を防げる
- フロントのロジックがシンプルになる
- サーバー側で校正ロジックを一元管理できる

---
Django側でもこの設計思想を踏襲し、校正結果HTMLをサーバーで生成・返却する形にリファクタリングすること。

---

# 校正AI v2 - 次世代モデル対応版

## 概要
Claude 3.5 Sonnet v2 / Claude 4を活用した高度な校正AI機能。4つのカテゴリーに分けた色分けハイライトで、より詳細で実用的な修正提案を提供。

## 機能仕様

### 🎨 4色ハイライトシステム

#### 1. 🟣 言い回しアドバイス（紫色）
- **目的**: 弊社記事ルールに基づく温かみのある表現への修正
- **対象**: 
  - 硬い表現 → 親しみやすい表現
  - 専門用語 → 分かりやすい言葉
  - 冷たい印象 → 温かい印象の文章
- **例**: 
  - 「実施する」→「行う」
  - 「検討してください」→「ご検討いただけますでしょうか」
  - 「不可能です」→「難しい状況です」

#### 2. 🔴 誤字修正（赤色）
- **目的**: 基本的な誤字脱字の修正
- **対象**:
  - タイポ、変換ミス
  - 送り仮名の間違い
  - 同音異義語の誤用
- **例**:
  - 「増加期傾向」→「増加傾向」
  - 「以外」→「意外」
  - 「会議室を予約する」→「会議室を予約する」

#### 3. 🟡 社内辞書ルール修正（黄色）
- **目的**: 社内統一表記ルールの適用
- **対象**:
  - 会社固有の用語統一
  - ブランド名の正式表記
  - 社内ルールに基づく表現統一
- **例**:
  - 「AI」→「人工知能（AI）」（初出時）
  - 「弊社」→「当社」
  - 「お客様」→「お客さま」

#### 4. 🟠 矛盾チェック（オレンジ色）
- **目的**: 文章内の論理的・事実的矛盾の指摘
- **対象**:
  - 地名の誤記や地理的矛盾
  - 時系列の矛盾
  - 数値や統計の不整合
  - 論理的な矛盾
- **例**:
  - 「東京都大阪市」→「大阪府大阪市」
  - 「北海道の梅雨」→「本州の梅雨」
  - 「2023年に発表された2024年のデータ」→「2024年に発表されたデータ」
  - 「増加している」と「減少している」の同時記述

## 技術仕様

### モデル選択
```python
# Claude 3.5 Sonnet v2 (推奨)
MODEL_ID_V2 = "anthropic.claude-3-5-sonnet-20241022-v2:0"

# Claude 4 (将来対応)
MODEL_ID_V4 = "anthropic.claude-4-20240620-v1:0"  # 仮想ID
```

### データ構造
```python
class CorrectionV2:
    original: str           # 修正前テキスト
    corrected: str         # 修正後テキスト
    reason: str            # 修正理由
    category: str          # カテゴリー（tone/typo/dict/geo）
    confidence: float      # 信頼度（0.0-1.0）
    position: int          # 文字位置
    severity: str          # 重要度（high/medium/low）
```

### カテゴリー定義
```python
CORRECTION_CATEGORIES = {
    'tone': {
        'name': '言い回しアドバイス',
        'color': '#E9D5FF',  # 紫色
        'border': '#8B5CF6',
        'icon': '💬'
    },
    'typo': {
        'name': '誤字修正',
        'color': '#FEE2E2',  # 赤色
        'border': '#EF4444',
        'icon': '❌'
    },
    'dict': {
        'name': '社内辞書ルール',
        'color': '#FEF3C7',  # 黄色
        'border': '#F59E0B',
        'icon': '📚'
    },
    'inconsistency': {
        'name': '矛盾チェック',
        'color': '#FED7AA',  # オレンジ色
        'border': '#F97316',
        'icon': '⚠️'
    }
}
```

### プロンプト設計
```markdown
あなたは日本語文章の校正専門AIです。以下の4つのカテゴリーで文章を分析し、修正提案を行ってください：

1. **言い回しアドバイス（tone）**: 温かみのある表現への修正
2. **誤字修正（typo）**: 基本的な誤字脱字の修正
3. **社内辞書ルール（dict）**: 統一表記ルールの適用
4. **矛盾チェック（geo）**: 文章内の論理的・事実的矛盾の指摘

## 社内記事ルール
- 親しみやすく温かい表現を心がける
- 専門用語は分かりやすく説明する
- 読者に寄り添う文章にする

## 社内辞書ルール
{社内辞書データ}

## 出力形式
✅修正箇所：
- カテゴリー: (修正前) -> (修正後): 理由 [信頼度: 0.95]
```

### UI/UX設計

#### ハイライト表示
```css
.correction-tone {
    background-color: #FEF3C7;
    border-bottom: 2px dashed #F59E0B;
}

.correction-typo {
    background-color: #FEE2E2;
    border-bottom: 2px dashed #EF4444;
}

.correction-dict {
    background-color: #DBEAFE;
    border-bottom: 2px dashed #3B82F6;
}

.correction-geo {
    background-color: #FED7AA;
    border-bottom: 2px dashed #F97316;
}
```

#### フィルター機能
- カテゴリー別表示/非表示切り替え
- 信頼度による絞り込み
- 重要度による並び替え

#### 統計表示
- カテゴリー別修正件数
- 全体の校正スコア
- 改善提案の受け入れ率

## 実装計画

### Phase 1: 基盤構築
1. Claude 3.5 Sonnet v2対応
2. カテゴリー分類システム
3. 色分けハイライト機能

### Phase 2: 高度化
1. 社内辞書管理システム
2. 矛盾検出データベース連携
3. 学習機能（ユーザーフィードバック）

### Phase 3: 最適化
1. リアルタイム校正
2. 一括修正機能
3. 校正レポート生成

## 期待効果
- 📈 校正精度の向上（90%以上）
- 🎯 カテゴリー別の明確な修正指針
- 💡 社内ライティング品質の統一
- 🚀 編集作業効率の大幅改善 