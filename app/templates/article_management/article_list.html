{% extends 'base/base_bootstrap.html' %}
{% load static %}

{% block title %}記事一覧 - Grape{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4">記事一覧</h1>
        </div>
        <div class="col-auto">
            <a href="{% url 'article_management:article_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> 新規記事作成
            </a>
        </div>
    </div>

    <!-- 検索・フィルター -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <input type="text" name="search" class="form-control" 
                           placeholder="内容、記事番号、ID で検索" value="{{ request.GET.search }}">
                </div>
                <div class="col-md-3">
                    <select name="status" class="form-control">
                        <option value="">すべてのステータス</option>
                        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>申請中</option>
                        <option value="through" {% if request.GET.status == 'through' %}selected{% endif %}>スルー</option>
                        <option value="ng" {% if request.GET.status == 'ng' %}selected{% endif %}>掲載NG</option>
                        <option value="need_permission" {% if request.GET.status == 'need_permission' %}selected{% endif %}>要許可</option>
                        <option value="no_apply" {% if request.GET.status == 'no_apply' %}selected{% endif %}>申請不要</option>
                        <option value="published" {% if request.GET.status == 'published' %}selected{% endif %}>公開済</option>
                        <option value="info_provided" {% if request.GET.status == 'info_provided' %}selected{% endif %}>情報提供</option>
                        <option value="-" {% if request.GET.status == '-' %}selected{% endif %}>-</option>
                        <option value="post_report" {% if request.GET.status == 'post_report' %}selected{% endif %}>事後報告</option>
                        <option value="original" {% if request.GET.status == 'original' %}selected{% endif %}>独自記事</option>
                    </select>
                </div>
                {% if user.is_staff %}
                <div class="col-md-3">
                    <select name="writer" class="form-control">
                        <option value="">すべてのライター</option>
                        {% for writer in writers %}
                        <option value="{{ writer.id }}" {% if request.GET.writer == writer.id|stringformat:"s" %}selected{% endif %}>
                            {{ writer.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> 検索
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 記事一覧テーブル -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>記事番号</th>
                    <th>掲載報告</th>
                    <th>ステータス</th>
                    <th>公開日</th>
                    <th>申請日</th>
                    <th style="white-space: nowrap;">提案者</th>
                    <th>ライター</th>
                    <th>内容</th>
                    <th>Facebookテキスト</th>
                    <th>SNS</th>
                    <th>参照記事URL</th>
                    <th>元ネタの作成者ID</th>
                    <th>操作</th>
                    <th>備考</th>
                </tr>
            </thead>
            <tbody>
                {% for article in articles %}
                <tr>
                    <td>{{ article.article_id }}</td>
                    <td>
                        <select class="form-control form-control-sm report-status-select" 
                                data-article-id="{{ article.article_id }}"
                                style="width: auto; min-width: 140px;">
                            <option value="not_required" {% if article.report_status == 'not_required' %}selected{% endif %}>不要</option>
                            <option value="sent" {% if article.report_status == 'sent' %}selected{% endif %}>送信済み</option>
                            <option value="ready_with_x" {% if article.report_status == 'ready_with_x' %}selected{% endif %}>準備完了Xあり</option>
                            <option value="ready_without_x" {% if article.report_status == 'ready_without_x' %}selected{% endif %}>準備完了Xなし</option>
                        </select>
                    </td>
                    <td>
                        <span class="badge bg-{{ article.get_status_color }}">
                            {{ article.get_status_display }}
                        </span>
                    </td>
                    <td>{{ article.published_at|date:"m/d"|default:"-" }}</td>
                    <td>{{ article.created_at|date:"m/d" }}</td>
                    <td>{{ article.applicant.username }}</td>
                    <td>{{ article.writer.username|default:"-" }}</td>
                    <td>
                        <a href="{% url 'article_management:article_detail' article.article_id %}" class="text-decoration-none text-info">
                            {{ article.content|truncatechars:50 }}
                        </a>
                    </td>
                    <td>
                        {{ article.facebook_text|truncatechars:30|default:"-" }}
                    </td>
                    <td>
                        {% if article.reference_url %}
                            {% if 'youtube.com' in article.reference_url or 'youtu.be' in article.reference_url %}
                                <i class="fab fa-youtube text-danger" title="YouTube"></i>
                            {% elif 'x.com' in article.reference_url or 'twitter.com' in article.reference_url %}
                                <i class="fab fa-twitter text-info" title="X (Twitter)"></i>
                            {% elif 'instagram.com' in article.reference_url %}
                                <i class="fab fa-instagram text-warning" title="Instagram"></i>
                            {% elif 'threads.com' in article.reference_url %}
                                <i class="fas fa-at text-dark" title="Threads"></i>
                            {% elif 'tiktok.com' in article.reference_url %}
                                <i class="fab fa-tiktok" title="TikTok"></i>
                            {% else %}
                                <i class="fas fa-globe text-secondary" title="Web"></i>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if article.reference_url %}
                            <a href="{{ article.reference_url }}" target="_blank" class="text-info">
                                <i class="fas fa-external-link-alt"></i> 見る
                            </a>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ article.social_media_id|default:"-" }}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="{% url 'article_management:article_detail' article.article_id %}" 
                               class="btn btn-sm btn-outline-info" title="詳細">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if user.is_staff or article.applicant == user or article.writer == user %}
                            <a href="{% url 'article_management:article_edit' article.article_id %}" 
                               class="btn btn-sm btn-outline-warning" title="編集">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ article.notes|truncatechars:30|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="14" class="text-center py-4">
                        <p class="mb-0">記事が見つかりませんでした。</p>
                        <a href="{% url 'article_management:article_create' %}" class="btn btn-primary mt-2">
                            <i class="fas fa-plus"></i> 新規記事を作成
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ページネーション -->
    {% if is_paginated %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                    最初
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                    前へ
                </a>
            </li>
            {% endif %}
            
            <li class="page-item active">
                <span class="page-link bg-primary border-primary">
                    {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                </span>
            </li>
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                    次へ
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                    最後
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<style>
/* NGユーザーバッジのホバー時にツールチップ表示 */
.badge[title]:hover {
    cursor: help;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 掲載報告ステータスの変更を処理
    const reportStatusSelects = document.querySelectorAll('.report-status-select');
    
    reportStatusSelects.forEach(select => {
        select.addEventListener('change', function() {
            const articleId = this.dataset.articleId;
            const newStatus = this.value;
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            
            // APIリクエストを送信
            fetch(`/articles/api/update-report-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    article_id: articleId,
                    report_status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 成功時の視覚的フィードバック
                    this.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 1000);
                } else {
                    // エラー時は元の値に戻す
                    alert('更新に失敗しました: ' + (data.error || 'Unknown error'));
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('エラーが発生しました');
                location.reload();
            });
        });
    });
});
</script>
{% endblock %}