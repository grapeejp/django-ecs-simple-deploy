# ブランチ戦略

本プロジェクトでは、GitHubフローをベースにしたシンプルなブランチ戦略を採用します。

## ブランチ構成

- `main`: 常にデプロイ可能な状態を維持するプロダクションブランチ
- 機能ブランチ：新機能開発やバグ修正用の一時的なブランチ

## ブランチ命名規則

機能ブランチは以下の命名規則に従って作成します：

- 機能追加: `feature/機能名`
- バグ修正: `fix/問題名`
- リファクタリング: `refactor/対象名`
- ドキュメント: `docs/内容`
- 緊急修正: `hotfix/問題名`

例:
```
feature/django-health-check
fix/cors-issue
refactor/docker-multi-stage
docs/deployment-guide
hotfix/security-vulnerability
```

## 開発フロー

### 1. 新機能開発 / バグ修正

1. `main`ブランチから新しい機能ブランチを作成
   ```bash
   git checkout main
   git pull
   git checkout -b feature/新機能
   ```

2. 機能ブランチで開発を実施
   - 適切な単位でコミットを作成
   - コミットメッセージは具体的かつ明確に記述

3. 開発完了後、GitHub上でプルリクエストを作成
   - プルリクエストのタイトルと説明には変更内容を明確に記述
   - レビュアーをアサイン

4. コードレビュー実施
   - 少なくとも1名のレビュアーによる承認が必要

5. プルリクエストがレビューされ承認されたら`main`ブランチにマージ
   - マージは「Squash and merge」または「Rebase and merge」を推奨

### 2. デプロイ

1. `main`ブランチへのマージ後、自動的にデプロイパイプラインが実行される
   - CI/CDパイプラインで自動テストが実行される
   - テスト成功後、ステージング環境に自動デプロイ

2. ステージング環境での検証
   - 手動テストや自動化されたE2Eテストでの検証

3. 本番環境へのデプロイ
   - 手動承認または特定のタグ付けにより本番デプロイを実行

### 3. 緊急修正（Hotfix）

1. `main`ブランチから直接`hotfix`ブランチを作成
   ```bash
   git checkout main
   git pull
   git checkout -b hotfix/緊急問題
   ```

2. 修正を実施してプルリクエスト作成
   - 緊急度に応じて簡略化されたレビュープロセスを適用可能

3. マージ後すぐにデプロイ
   - 本番環境への影響範囲を最小限に抑えた修正を心がける

## プルリクエストのルール

1. **説明**: 変更内容と目的を明確に記述
2. **サイズ**: 可能な限り小さな変更単位に分割する
3. **テスト**: 自動テストが成功していることを確認
4. **レビュー**: 重要な変更の場合、少なくとも1名のレビュアーによる承認が必要（下記「重要な変更の基準」参照）
5. **ブランチ保護**: `main`ブランチへの直接プッシュは禁止

### 重要な変更の基準

以下の基準のいずれか1つでも該当する場合は「重要な変更」と判断し、レビューを必須とします：

1. **サイズによる判断**：
   - 50行以上のコード変更
   - 3ファイル以上を変更するPR

2. **重要な対象**：
   - データベース関連（モデル、マイグレーション）
   - 認証・権限関連のコード
   - 外部APIとの連携部分
   - 設定ファイルの変更

3. **機能タイプ**：
   - 新機能の追加（featureブランチ）
   - 既存機能の大幅変更

4. **PRテンプレートでの自己申告**：
   - PRテンプレートのチェックボックス「□ このPRは重要な変更を含みます」にチェックがある場合

上記に該当しない軽微な変更（typo修正、小さなスタイル変更など）は、レビューなしでもマージ可能です。ただし、自信がない場合は任意でレビューを依頼することを推奨します。

## マージ後のクリーンアップ

マージされたブランチは、以下の手順でクリーンアップを行います：

```bash
# リモートブランチの最新情報を取得
git fetch --prune

# ローカルのマージ済みブランチを削除
git branch --merged | grep -v "\*" | grep -v "main" | xargs -n 1 git branch -d

# リモートのブランチを確認
git branch -r
```

## Dockerイメージタグ戦略

CI/CDパイプラインでビルドされるDockerイメージには、以下のタグ付け戦略を採用します。これにより、どのコードバージョンのイメージがどの環境にデプロイされているかを明確に識別できるようにします。

- **ステージング環境向けイメージ**:
  - `main` ブランチへの各コミットに対してビルドされ、ECRにプッシュされます。
  - タグには、**コミットハッシュ (`github.sha` の先頭部分など)** を使用します。
    例: `sha-a1b2c3d`
  - オプションとして `latest-staging` タグも付与することがあります。

- **本番環境向けイメージ**:
  - GitHub上で作成された**リリースタグ (`vX.Y.Z` 形式推奨)** をトリガーにビルドされ、ECRにプッシュされます。
  - タグには、その**リリースタグ名**をそのまま使用します。
    例: `v1.0.0`, `v1.1.0`
  - オプションとして `latest` タグも付与することがあります（本番環境の最新安定版を示す）。

このタグ戦略により、特定のコミットやリリースに対応するDockerイメージを正確に指定してデプロイやロールバックを行うことが可能になります。 