# デプロイ手順

本ドキュメントでは、Django アプリケーションを AWS ECS にデプロイするための手順について説明します。

## 前提条件

- AWSアカウントへのアクセス権限
- AWS CLIのインストールと設定
- Dockerのインストール
- GitHubリポジトリへのアクセス権限

## デプロイ環境

本プロジェクトでは以下の環境を定義しています：

- **開発環境（Development）**: 開発者のローカル環境
- **テスト環境（Test）**: CI/CDパイプラインで自動テストを実行する環境
- **ステージング環境（Staging）**: 本番環境と同等の構成で動作確認を行う環境
- **本番環境（Production）**: エンドユーザーが実際に利用する環境

## デプロイフロー

デプロイは以下のフローで実施されます：

```
開発者のローカル環境
      ↓
GitHub（プルリクエスト）
      ↓
CI/CD（自動テスト）
      ↓
ステージング環境（動作確認）
      ↓
本番環境
```

## 手動デプロイ手順

CI/CDパイプラインが整備されるまでの間は、以下の手順で手動デプロイを行います。

### 1. 環境変数の設定

```bash
# AWSアカウント情報
export AWS_ACCOUNT_ID=<あなたのAWSアカウントID>
export AWS_REGION=ap-northeast-1
```

### 2. ECRリポジトリにDockerイメージをプッシュ

```bash
# ECRにログイン
aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

# イメージをビルドしてタグ付け
docker build -t django-ecs-app .
docker tag django-ecs-app:latest $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/django-ecs-app:latest

# ECRにプッシュ
docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/django-ecs-app:latest
```

### 3. CloudFormationスタックの作成・更新

初回デプロイ時は作成、以降は更新を行います。

```bash
# ECSクラスターの作成/更新
aws cloudformation deploy \
  --stack-name django-ecs-cluster \
  --template-file cloudformation/ecs-cluster.yml \
  --capabilities CAPABILITY_IAM

# ECSサービスの作成/更新
aws cloudformation deploy \
  --stack-name django-ecs-service \
  --template-file cloudformation/ecs-service.yml \
  --parameter-overrides \
    ImageUrl=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/django-ecs-app:latest
```

### 4. デプロイ結果の確認

```bash
# サービスのステータス確認
aws ecs describe-services \
  --cluster django-ecs-cluster \
  --services django-ecs-service

# ロードバランサーのDNS名を取得
aws cloudformation describe-stacks \
  --stack-name django-ecs-service \
  --query "Stacks[0].Outputs[?OutputKey=='LoadBalancerDNS'].OutputValue" \
  --output text
```

取得したDNS名にアクセスして、アプリケーションが正常に動作していることを確認します。

## 自動デプロイ（CI/CD）

GitHub Actionsを使用して自動デプロイを行う場合、以下の流れでデプロイが実行されます。

### 1. GitHub Secretsの設定

GitHubリポジトリの設定ページから以下のSecretを設定します：

- `AWS_ACCESS_KEY_ID`: AWSアクセスキーID
- `AWS_SECRET_ACCESS_KEY`: AWSシークレットアクセスキー
- `AWS_REGION`: AWSリージョン（例：ap-northeast-1）
- `AWS_ACCOUNT_ID`: AWSアカウントID

### 2. ワークフローの実行

- `main`ブランチへのプッシュ: ステージング環境へ自動デプロイ
- リリースタグの作成: 本番環境へ自動デプロイ

## ロールバック手順

デプロイに問題が発生した場合のロールバック手順です。

### 1. 前バージョンのイメージタグを確認

```bash
aws ecr describe-images \
  --repository-name django-ecs-app \
  --query 'imageDetails[*].[imageTags,imagePushedAt]' \
  --output text | sort -k 2
```

### 2. 前バージョンのイメージを使用してサービスを更新

```bash
aws cloudformation deploy \
  --stack-name django-ecs-service \
  --template-file cloudformation/ecs-service.yml \
  --parameter-overrides \
    ImageUrl=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/django-ecs-app:<前バージョンのタグ>
```

### 3. ロールバック結果の確認

ロードバランサーのDNS名にアクセスして、アプリケーションが正常に動作していることを確認します。

## トラブルシューティング

### ECSサービスのデプロイに失敗する場合

1. ECSサービスイベントを確認
   ```bash
   aws ecs describe-services \
     --cluster django-ecs-cluster \
     --services django-ecs-service \
     --query 'services[0].events'
   ```

2. タスク定義の問題を確認
   ```bash
   aws ecs describe-task-definition \
     --task-definition django-ecs-app
   ```

3. CloudWatch Logsでコンテナログを確認
   ```bash
   aws logs get-log-events \
     --log-group-name /ecs/django-ecs-app \
     --log-stream-name <ログストリーム名>
   ```

### ヘルスチェックに失敗する場合

1. ターゲットグループのヘルスチェック設定を確認
   ```bash
   aws elbv2 describe-target-groups \
     --names django-ecs-tg
   ```

2. セキュリティグループの設定を確認
   ```bash
   aws ec2 describe-security-groups \
     --group-ids <セキュリティグループID>
   ```

3. アプリケーションのヘルスチェックエンドポイントが正常に応答するか確認 