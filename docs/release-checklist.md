# 本番リリース詳細チェックリスト

## リリース前準備

### コード品質確認
- [ ] すべての自動テストがパスしている
- [ ] コードレビューが完了している
- [ ] セキュリティスキャン（bandit）に問題がない
- [ ] コーディング規約チェック（ruff）に問題がない
- [ ] リリースノートが作成済みである
- [ ] 変更内容とテスト結果をチームで共有している

### データベース関連
- [ ] 新規マイグレーションファイルの確認
  - マイグレーションの依存関係に問題がないか
  - 大規模なデータ移行がある場合、実行時間の見積もり
- [ ] マイグレーションのロールバック計画の確認
  - 各マイグレーションに対応するロールバック手順
- [ ] データベースバックアップの実施

#### バックアップ手順
```bash
# AWS RDS バックアップ作成例
aws rds create-db-snapshot \
  --db-instance-identifier your-db-instance \
  --db-snapshot-identifier pre-deploy-YYYY-MM-DD
  
# バックアップ状態確認
aws rds describe-db-snapshots \
  --db-snapshot-identifier pre-deploy-YYYY-MM-DD
```

### 環境設定確認
- [ ] 本番環境の環境変数設定を確認
  - `SECRET_KEY`
  - `DATABASE_URL`
  - `ALLOWED_HOSTS`
  - その他必要な環境変数
- [ ] AWS リソースのIAM権限確認
  - ECSタスク実行ロール
  - ECRプッシュ権限
- [ ] セキュリティグループ設定の確認
  - 必要なポートだけが開放されているか

### インフラストラクチャ
- [ ] CloudFormationテンプレートの変更確認
- [ ] ECSサービス/タスク定義の変更確認
- [ ] ALB設定（ヘルスチェックパス等）の確認
- [ ] スケーリング設定の確認

## デプロイプロセス

### リリースタグ作成
- [ ] 適切なバージョン番号の設定（セマンティックバージョニング）
- [ ] リリースノートの完成
- [ ] タグの作成と公開（GitHub UI または CLI）

```bash
# CLIでのリリースタグ作成例
VERSION="v1.0.0"
DESCRIPTION="リリース内容の概要"

# タグを作成
git tag -a $VERSION -m "$DESCRIPTION"

# タグをプッシュ
git push origin $VERSION
```

### デプロイ監視
- [ ] GitHub Actionsワークフローのモニタリング
- [ ] CloudFormationスタック更新の監視
- [ ] ECSサービスデプロイの監視
- [ ] アプリケーションヘルスチェックの監視

## デプロイ後確認

### 基本動作確認
- [ ] アプリケーションにアクセス可能か
- [ ] 主要機能が正常に動作するか
- [ ] エラーログに異常がないか
- [ ] パフォーマンスに問題がないか

### モニタリング設定
- [ ] CloudWatchアラームの設定
- [ ] エラー通知の設定
- [ ] ヘルスチェックの設定

## ロールバック手順

### ロールバック判断基準
- 致命的なバグが発見された
- サービス全体のパフォーマンスが著しく低下
- セキュリティ上の重大な問題が発見された

### アプリケーションコードのロールバック
```bash
# 前のリリースタグに戻す場合
PREVIOUS_VERSION="v0.9.0"

# タグをチェックアウト
git checkout $PREVIOUS_VERSION

# 新しいリリースタグを作成（ロールバック用）
ROLLBACK_VERSION="v1.0.1-rollback"
git tag -a $ROLLBACK_VERSION -m "Rolling back to $PREVIOUS_VERSION"
git push origin $ROLLBACK_VERSION
```

### データベースのロールバック
```bash
# AWS RDSスナップショットからの復元例
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier your-db-instance \
  --db-snapshot-identifier pre-deploy-YYYY-MM-DD
```

## 緊急時対応フロー

### 重大な障害発生時
1. **初期対応（最初の30分）**
   - 緊急対応チームを招集
   - 現象と影響範囲の特定
   - ユーザーへの初期通知

2. **分析フェーズ（30分〜1時間）**
   - ログ分析による原因特定
   - 一時的な回避策の検討
   - ステークホルダーへの状況報告

3. **対応フェーズ（1時間〜）**
   - ロールバック判断
   - 修正パッチの適用
   - 継続的なモニタリング

4. **収束確認**
   - 全機能の動作確認
   - パフォーマンス確認
   - 再発防止策の検討

### コミュニケーション計画
- 障害発生時の連絡先リスト
  - プロジェクトマネージャー: xxx-xxxx-xxxx
  - インフラ担当者: xxx-xxxx-xxxx
  - バックエンド開発者: xxx-xxxx-xxxx
  - フロントエンド開発者: xxx-xxxx-xxxx
- ステークホルダーへの報告フォーマット
  - 発生時刻
  - 影響範囲
  - 現在の状況
  - 対応予定時間
  - 次回の更新予定

## リリース完了報告

### 報告内容
- [ ] デプロイ完了時刻
- [ ] 導入された新機能の概要
- [ ] 修正されたバグの一覧
- [ ] 既知の問題点
- [ ] 次回リリース予定

### フィードバックの収集
- [ ] リリース後の問題点の収集
- [ ] 次回リリース時の改善点のまとめ 